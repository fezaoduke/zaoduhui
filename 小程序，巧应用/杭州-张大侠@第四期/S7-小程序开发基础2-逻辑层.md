
逻辑层，处理事务逻辑。在微信小程序里就是所有.js脚本文件的集合。微信小程序**在逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈**。

微信小程序逻辑层由js编写，与传统js不同的是：
- 增加了App和Page方法，进行程序和页面的注册
- 提供丰富的API，如扫一扫、支付等微信特有能力
- 每个页面由独立的作用域，并提供模块化能力
- 由于js并非运行在浏览器中，所以与浏览器相关的js API都无法使用，例如DOM操作、window全局变量等。

在开发过程中，逻辑层的实现即为编写各个页面的.js脚本，最终将会打包成一份js文件，并在小程序启动的时候运行，直到小程序销毁。类似_Service Worker_。因此逻辑层也成为App Service。

## 注册程序~App()方法

作用：注册一个小程序，整个小程序有且仅有一个App()方法，存在app.js中。

参数：object，主要用于指定小程序的生命周期等

参数说明：

- onLaunch：Function/生命周期函数——监听小程序**初始化**/当小程序初始化完成时，会触发onLaunch函数（并且**全局只会触发一次**）
- onShow：Function/生命周期函数——监听小程序**显示**/当小程序显示时（启动，或从后台进入前台），会触发onShow函数
- onHide：Function/生命周期函数——监听小程序**隐藏**/当小程序从前台进入后台，会触发onHide函数
- 其他：Any/开发者可以添加任意的函数或数据到Object参数中，用this可以访问

Q：小程序前台，后台？
A：用户当前**界面运行**或**操作小程序**时为前台；当用户**点击左上角关闭**，或者**按了设备HOME键离开微信**，小程序则进入了后台，注意此时小程序**并没有直接销毁**！当再次进入微信（直接进入小程序界面）或再次打开小程序，又会从后台进入前台。

Q：小程序什么时候会被销毁？
A：只有当小程序**进入后台一定时间**，或者**系统资源占用过高**，才会被真正销毁。此时代表小程序的生命周期结束。

另外，微信小程序在App()函数外（函数内用this便可获取）提供了全局获取的getApp()函数，可以用来获取小程序实例。注意获取实例后，不可私自调用生命周期函数！

## 注册页面~Page()方法

作用：注册一个页面，在每个页面有且仅有一个Page()方法，存在该页面的.js文件中

参数：object，用于指定页面的初始数据、生命周期函数、事件处理函数等。

参数说明：

- data：Object/页面的初始数据
- onLoad：Function/生命周期函数-监听页面加载
- onReady：Function/生命周期函数-监听页面初次渲染完成
- onShow：Function/生命周期函数-监听页面显示
- onHide：Function/生命周期函数-监听页面隐藏
- onUnload：Function/生命周期函数-监听页面卸载
- onPullDownRefreash：Function/页面相关事件处理函数——监听用户下拉动作
- onReachBottom：Function/页面上拉触底事件的处理函数
- 其他：Any/开发者可以添加任意的函数或数据到object参数中，用this可以访问

另外，微信小程序提供了getCurrentPage()函数，用来获取当前页面的实例。需要注意的是**在App()中进行onLaunch操作的时候不要调用此函数**，因为当前page还未生成。（笔者注：在函数里面不可以用this获取到吗？而且此方法应该是只有在本函数内使用吗？）

1、 初始化数据
页面第一次渲染时，对象data将会以JSON的形式由逻辑层传至视图层（注意，数据必须能够转成JSON格式，例如字符串、数字、布尔值、对象、数组），视图层通过WXML对数据进行**绑定**（笔者注：如何绑定？）。

2、 生命周期函数使用介绍
生命周期函数包括onLoad、onShow、onReady、onHide、onUnload。

- onLoad：页面加载时执行的初始化操作，一个页面只会调用一次，参数可以获取wx.navigateTo和wx.redirectTo及navigator组件中的query
- onShow：页面显示时执行的操作，每次打开页面都会调用一次
- onReady： 页面初次渲染完成时执行的操作，一个页面只会调用一次，代表页面已经准备妥当，可以和视图层进行交互，对页面的设置（如wx.setNavigationBarTitle）须在onReady之后设置。
- onHide：页面隐藏时执行的操作，当navigateTo或底部进行tab切换时调用
- onUnload：页面卸载时执行的操作，当进行redirectTo或navigateBack操作时调用

3、 页面相关事件处理函数
onPullDownRefresh是下拉刷新时执行的操作。

- 监听用户下拉刷新事件
- 需要在config的window选项中开启enablePullDownRefresh
- 当处理完数据刷新后，wx.stopPullDownRefresh可以停止当前页面的下拉刷新

4、 事件处理函数
除了初始化数据和生命周期函数，Page()方法还可以定义一些特殊的函数：事件处理函数。
我们可以在视图层通过对组件加入事件绑定，当满足触发事件时，就会执行Page()中定义的事件处理函数。

5、 页面数据设置及展现
在Page()中，我们要使用setData函数来讲数据从逻辑层发送到视图层，同时改变对应的this.data的值。
注意：

- 直接修改this.data无效，无法改变页面的状态，还会造成数据的不一致
- 单词设置的数据不能超过**1024KB**，请尽量避免一次设置过多的数据
**setData()函数**接收一个对象作为参数。以“key, value”的形式表示将this.data中的key对应的值改变为value。
其中key可以非常灵活，包括以数据路径的形式给出，如array[2].message, a.b.c.d，并且无须在this.data中预先定义。

6、 页面栈及其实例获取
小程序框架以栈的形式维护了当前的所有页面。当发生路由切换的时候，对应页面栈表现为：

- 初始化：新页面入栈
- 打开新页面：新页面入栈
- 页面重定向：当前页面出栈，新页面入栈
- 页面返回：页面不断出栈，直到目标返回页，新页面入栈
- Tab切换：当前页面出栈，新页面入栈
**getCurrentPages()函数**用来获取当前页面栈的实例，以数组形式按栈的顺序给出，第一个是首页，最后一个元素为当前页面。
注意：不要尝试修改页面栈，会导致路由以及页面状态错误。

7、 理解页面生命周期
见下图：
![小程序页面生命周期](http://ols8kn0qk.bkt.clouddn.com/20160924153316501.jpg)

8、 页面的路由
小程序框架管理所有的页面路由，路由的触发方式及对应页面生命周期函数如下：

- 初始化，小程序打开的第一个页面（触发方式），onLoad，onShow（路有后页面），无（路由前页面）
- 打开新页面，调用APIwx.navigateTo或使用组件navigator，onLoad，onShow，onHide
- 页面重定向，调用APIwx.redirectTo或使用组件navigator，onLoad，onShow，onUnload
- 页面返回，调用APIwx.navigateBack或用户按左上角返回按钮，onShow，onUnload
- Tab切换，多Tab模式下用户切换Tab，第一次打开onLoad，onShow；否则onShow，onHide

## 模块及调用
1. 文件作用域
在微信小程序中，页面的JavaScript(.js)脚本文件声明的变量和函数只在该文件中有效。不同文件中可以声明相同名字的变量和函数，不会互相影响。

2. 模块化
可以将一些公共的代码抽抽离成为一个单独的.js脚本文件，作为一个模块。（注意：模块只有通过module。exports才能对外暴露接口以供其他.js文件引入使用）
在需要使用这些模块的.js文件中，使用require(path)将公共代码引入。

## 微信原生API
原生API共分为七大类：网络、媒体、数据、位置、设备、界面以及微信开放接口。
参照：https://mp.weixin.qq.com/debug/wxadoc/dev/api/

